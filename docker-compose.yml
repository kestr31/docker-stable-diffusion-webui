version: "3"
services:
  stable-diffusion:
    image: kestr3l/stable-diffusion-webui:1.2.0
    restart: unless-stopped
    container_name: stable-diffusion-webui
    secrets:
      - gradio_auth
    environment:
      - NVIDIA_DISABLE_REQUIRE=1
      - NVIDIA_DRIVER_CAPABILITIES=all
      - UID=<YOUR_UID>
      - GID=<YOUR_GID>
      - DIR_GRADIO_AUTH=/run/secrets/gradio_auth
      # Get UID and GID using following commands:
      #   For UID: echo $(id -u)
      #   For GID: echo $(id -g)
    volumes:
      # SET FOR STABLE-DIFFUSION-WEBUI SETTINGS
      - <YOUR_DIRECTORY_TO_MODELS>:/home/user/stable-diffusion-webui/models/Stable-diffusion
      - <YOUR_DIRECTORY_TO_OUTPUT>:/home/user/stable-diffusion-webui/outputs
      - <YOUR_DIRECTORY_TO_STYLES>:/home/user/stable-diffusion-webui/styles
      - <YOUR_DIRECTORY_TO_EXTENSIONS>:/home/user/stable-diffusion-webui/models/extensions
      - <YOUR_DIRECTORY_TO_VAE>:/home/user/stable-diffusion-webui/models/VAE
      - <YOUR_DIRECTORY_TO_config.json>:/home/user/stable-diffusion-webui/config.json
      - <YOUR_DIRECTORY_TO_webui-user.sh>:/home/user/stable-diffusion-webui/webui-user.sh
      # SET FOR LoRA TRAINING USING KOHYA_SS GUI
      - <YOUR_DIRECTORY_TO_LoRA_TRAINING_IAMGES>:/home/user/kohya_ss/images
      - <YOUR_DIRECTORY_TO_LoRA_TRAINING_LOGS>:/home/user/kohya_ss/logs
      - <YOUR_DIRECTORY_TO_LoRA_TRAINING_OUTPUT>:/home/user/kohya_ss/models
      - <YOUR_DIRECTORY_TO_LoRA_TRAINING_REGULARIZATIONS>:/home/user/kohya_ss/regularizations
      # SET FOR DEBUG PURPOSE
      # - <YOUR_DIRECTORY_TO_entrypoint-debug.sh>:/usr/local/bin/entrypoint.sh
    ports:
      # STABLE-DIFFUSION-WEBUI
      - <YOUR_PREFERRED_PORT>:7860
      # Kohya_SS GUI
      - <YOUR_PREFERRED_PORT>:7861
    privileged: true
    deploy:
      resources:
        reservations:
          devices:
            - capabilities: [gpu]
secrets:
  gradio_auth:
    file: ./secrets/gradio_auth.txt